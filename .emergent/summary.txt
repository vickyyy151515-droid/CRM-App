<analysis>**original_problem_statement**: The user wants to build a Customer Relationship Management (CRM) application.

The latest session focused on a comprehensive audit, standardization of business logic, and fixing numerous bugs and inconsistencies across the application. Key requests included:
1.  **System-Wide Logic Audit**: A request to audit and standardize the entire codebase to ensure universal application of:
    *   The tambahan rule (records with tambahan are always RDP).
    *   Case-insensitive matching for all customer identifiers.
    *   Correct and consistent duplicate checking for Reserved Members.
    *   The universal use of the customer's  (from uploaded files) as the primary identifier, and explicitly ignoring the  field for all logic.
2.  **Bug Fixes**:
    *   Fixing empty charts on the Advanced Analytics dashboard.
    *   Fixing a non-functional Delete button on the Manage Database page by replacing .
    *   Fixing a data integrity bug where requested records were not being updated to assigned status after approval.
    *   Fixing inconsistent RDP (Return Deposit) counts between the Monthly and Daily reports.
    *   Fixing inconsistent deposited counts across different views of the Conversion Funnel.
3.  **UI/UX Improvements**:
    *   Fixing layout issues on the main dashboard and Reserved Members page that prevented scrolling on vertical monitors.
    *   Adding a product filter and a date picker to the Daily Summary page.
    *   Adding more detailed date range filters (Today, Yesterday, Custom) to the Customer Retention page.
4.  **Clarity & Consistency**:
    *   A request to rename the Customer Name field to Customer ID in the Reserved Member feature to align with the rest of the app.

**User's preferred language**: English

**what currently exists?**
A comprehensive full-stack CRM application with a React frontend, FastAPI backend, and MongoDB database. The agent has just completed a major session focused on bug fixing, UI enhancements, and a system-wide audit to standardize core business logic ( rule, case-insensitivity, primary customer identifier) across all features, including Analytics, Reports, Conversion Funnel, and Retention.

**Last working item**:
-   **Last item agent was working**: Renaming the  field to  within the Reserved Members feature for application-wide consistency. This is a refactoring task that impacts both backend models/APIs and frontend components. The agent had identified all relevant files and was about to begin the code modifications.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: both
    -   **Backend**: Test the updated  endpoints via  to ensure creating, moving, and checking for duplicate reservations works with the new  field.
    -   **Frontend**: Use the screenshot tool to verify the UI on the Reserved Members page. Confirm the input label is Customer ID and that the core functionality (adding/moving a reservation) remains intact.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1**: Complete the refactoring of Reserved Members to use  instead of . (P0)

**Issues Detail**:
-   **Issue 1**:
    -   **Attempted fixes**: The agent successfully identified all backend and frontend files that use the  field in the context of the Reserved Members feature.
    -   **Next debug checklist**:
        1.  **Backend Refactor**:
            -   In  and other related files (, ), replace all instances of  with  in Pydantic models, API logic, and database queries related to .
        2.  **Frontend Refactor**:
            -   In , update the input label, state variables, and API request payloads from  to .
        3.  **Testing**:
            -   Thoroughly test the reservation workflow: adding a new reservation, ensuring duplicate checks work, and moving/transferring a reservation.
    -   **Why fix this issue and what will be achieved with the fix?**: This will standardize the primary customer identifier across the entire application, eliminating confusion and potential bugs arising from inconsistent field names ( vs. ).
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Both
    -   **Blocked on other issue**: None

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   Telegram Notifications for Expiring Reservations (P1)
    -   Advanced Batch Sorting/Filtering (P2)
    -   WhatsApp Quick Actions (P2)
    -   Email Notifications (P2)
-   **Future Tasks**:
    -   Quick Actions on Overview (P2)
    -   Financial ROI Tracking (P2, deferred by user)
    -   Izin Analytics (P2)

**Completed work in this session**
-   **System-Wide Logic Audit**: Verified and enforced consistent application of tambahan logic, case-insensitive matching, and the use of  as the primary customer ID across all backend routes. Removed  from username detection keys to prevent incorrect data matching. (DONE)
-   **Data Integrity Tool**: Created an admin tool (Fix Stuck Records) with a backend endpoint and UI button to resolve a bug where customer records were stuck in requested status after approval. (DONE)
-   **Report & Funnel Inconsistency Fixes**:
    -   Synchronized RDP calculation logic between Monthly and Daily reports. (DONE)
    -   Unified conversion logic across all views (Overview, By Product, By Staff) of the Conversion Funnel. (DONE)
-   **Bug Fixes**:
    -   Fixed empty charts in Advanced Analytics by correcting the database query field from Sat Jan 24 21:23:48 UTC 2026 to . (DONE)
    -   Fixed the non-functional Delete button on the database management page by implementing a custom confirmation modal. (DONE)
-   **UI/UX Enhancements**:
    -   Resolved horizontal scrolling issues on the main dashboard and Reserved Members page. (DONE)
    -   Added a product filter and a date-picker to the Daily Summary page. (DONE)
    -   Enhanced the Customer Retention page with more detailed date filter options (Today, Yesterday, Custom Range). (DONE)

**Earlier issues found/mentioned but not fixed**
-   None.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: WebSocket Connection Fails with 1006 Error in the preview environment.
-   **Recurrence count**: 2+
-   **Status**: BLOCKED
    Note: This is a known limitation of the preview environment and does not affect the deployed application. It only prevents real-time features from working during development previews.

**Code Architecture**


**Key Technical Concepts**
-   **Business Logic Standardization**: The primary focus was a system-wide audit to unify critical business rules (NDP/RDP, tambahan logic, case-insensitivity, primary identifier) across all reporting and analytics modules.
-   **Data Integrity & Tooling**: Created a specific admin tool () to correct data inconsistencies caused by a previous bug, demonstrating a pattern for building self-healing capabilities into the admin panel.
-   **Refactoring for Consistency**: The current task involves a cross-cutting refactor (renaming  to ) to improve code clarity and reduce future bugs.
-   **Backend**: FastAPI, APScheduler for background jobs.
-   **Frontend**: React, Shadcn UI.

**key DB schema**
-   ****: This collection is currently being refactored. The  field is being renamed to  to align with other collections.

**changes in tech stack**
-   None.

**All files of reference**
-   : The core logic for reservations, which is the main target of the current refactoring.
-   : Was heavily modified to standardize conversion logic.
-   : The frontend component for the feature currently being refactored.
-   : Contains the new Fix Stuck Records tool and the custom delete modal.
-   : Updated to document the newly standardized system-wide logic rules.

**Areas that need refactoring**:
-   The Reserved Member feature is currently being refactored to use .
-   **Opportunity**: Centralize shared helper functions like , , and  into a  file to reduce code duplication across route files.

**key api endpoints**
-   : A new admin tool to fix records stuck in the requested state.
-   , , : All endpoints were updated to use consistent, non-date-filtered logic for counting deposited customers.
-   : The endpoints for this feature are the target of the current refactoring task.

**Critical Info for New Agent**
-   **System-Wide Logic Rules are Finalized and CRITICAL**: A comprehensive audit was just completed. Adhere strictly to these rules documented in :
    1.  **Tambahan Logic**: Records with tambahan in the notes are always RDP and are excluded from first-deposit date calculations.
    2.  **Case-Insensitive Matching**: All customer identifier comparisons must be case-insensitive, typically by converting both sides to .
    3.  ** is the Primary Identifier**: The  from uploaded files is the key customer identifier. It's used as  in  and should be used consistently everywhere. The  field from uploads is for display only and must be ignored in all workflow logic.

**documents and test reports created in this job**
-   : Updated with the standardized business logic rules.

**Last 10 User Messages and any pending HUMAN messages**
1.  **Bug Report**: RDP count is different in Monthly vs. Daily reports. (Resolved)
2.  **Request (MAJOR)**: Audit the entire system to enforce tambahan logic, case-insensitivity, and consistent use of  as the primary identifier. (Resolved)
3.  **Question**: Asks for a breakdown of where  is used across the app. (Answered)
4.  **Request**: Change customer name to Customer ID in the Reserved Member feature for consistency. (IN PROGRESS)

**Project Health Check:**
-   **Broken**: None
-   **Mocked**: None

**3rd Party Integrations**
-   ****: For Gemini Flash (AI Message Variation Generator).
-   ****: For TOTP attendance system.
-   ****: For generating the initial TOTP secret QR code.
-   ****: For the daily OMSET trash cleanup job.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: None in this session.
-   **Known regressions**: None.

**Credentials to test flow:**
-   **Master Admin**:  / 
-   **Admin**:  / 
-   **Staff**:  / 

**What agent forgot to execute**
-   The previous agent was in the middle of executing the user's request to rename  to . It identified the files but did not perform the code edits. This task needs to be completed.</analysis>
